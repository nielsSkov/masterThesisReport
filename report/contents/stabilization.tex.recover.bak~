\chapter{Stabilization}
In this section the idea is to stabilize the pendulum in the unstable equilibrium. Ultimately this controller should be able to take over from the swing-up controller when some minimum catch angle is reached.\\
A sliding mode control strategy is employed to accomplish these goals. The design is based on \cite{HKKhalil}.\\
Firstly, the model of the system, from \autoref{eq:nonlinearStateSpace}, is considered in following form,
\begin{align}
  \begin{bmatrix}
    \dot{x_1} \\
    \dot{x_2} \\
    \dot{x_3} \\
    \dot{x_4}
  \end{bmatrix}
  &=
  \underbrace{
    \begin{bmatrix}
      x_3 \\
      x_4 \\
      \vec{M}^{-1}(x_1) ( - \vec{C}(x_1,x_3) - \vec{B}(x_3,x_4) - \vec{G}(x_1) )
    \end{bmatrix}
  }_{\vec{f}(\vec{x})}
  +
  \underbrace{ 
    \begin{bmatrix}
      0 \\
      0 \\
      \vec{M}^{-1}(x_1) \vec{F} 
    \end{bmatrix}
  }_{\vec{g}(\vec{x}) u}
  \label{eq:nonlinearStateSpace2} \ \ \ ,
\end{align}
where
\begin{align}
  \vec{M}^{-1}
  &=
  \begin{bmatrix}
    \frac{(M + m)}{l^2 m ( M + m - m \cos^2 x_1 )}  &  \frac{\cos x_1}{l (M + m - m \cos^2 x_1)} \\
    \frac{\cos x_1}{l (M + m - m \cos^2 x_1)}       &  \frac{1}{M + m - m \cos^2 x_1}
  \end{bmatrix}  \ \ \ ,
\end{align}
%
and states $ [\ x_1\ \ x_2\ \ x_3\ \ x_4\ ]^\mathrm{T} = [\ \theta\ \ x\ \ \dot{\theta}\ \ \dot{x}\ ]^\mathrm{T} $ and input vector $F = [\ 0 \ \ u \ ]^\mathrm{T}$ as before.

In \autoref{eq:nonlinearStateSpace2} the input, $u$, appear in two of the four state equations. To design a sliding mode controller for the system, it is transformed into \textit{regular form}, 
\begin{align}
\dot{\vec{\eta}} &=  \vec{f_a}(\vec{\eta},\xi) \nonumber   \\
\dot{\xi}        &=  f_b(\vec{\eta},\xi) + g_b(\vec{\eta},\xi) u    \ \ \ ,
\label{eq:regularForm}
\end{align}
%
where the input only appears on one state equation.
The transform is then given by,
\begin{align}
  \vec{T}(\vec{x}) &=
  \begin{bmatrix}
    \vec{\eta} \\
    \xi
  \end{bmatrix}
  \ \Rightarrow \ 
  \frac{\partial}{\partial t}\vec{T}(\vec{x})
  =
  \begin{bmatrix}
    \dot{\vec{\eta}} \\
    \dot{\xi}
  \end{bmatrix}
  \ \Rightarrow \ 
  \frac{\partial}{\partial t}\vec{T}(\vec{x})
  =
  \begin{bmatrix}
    \vec{f_a}(\vec{\eta},\xi)         \\
    f_b(\vec{\eta},\xi) + g_b(\vec{\eta},\xi) u
  \end{bmatrix}
   \ \ \ ,
  \label{eq:transformAndDerivative}
\end{align}
further,
\begin{align}
  \frac{\partial \vec{T}}{\partial t} &= \frac{\partial \vec{T}}{\partial \vec{x}}  \dot{\vec{x}} \\
  \begin{bmatrix}
    \vec{f_a}(\vec{\eta},\xi)         \\
    f_b(\vec{\eta},\xi) + g_b(\vec{\eta},\xi) u
  \end{bmatrix}
  &=
  \frac{\partial \vec{T}}{\partial \vec{x}} \vec{f}(\vec{x}) + \frac{\partial \vec{T}}{\partial \vec{x}} \vec{g}(\vec{x}) u
  \ \ \ ,
  \label{eq:transformDerivative}
\end{align}
such that,
\begin{align}
  \frac{\partial \vec{T}}{\partial \vec{x}} \vec{f}(\vec{x})    
  &= 
  \begin{bmatrix}
    \vec{f_a}(\vec{\eta},\xi)       \\
    f_b(\vec{\eta},\xi)
  \end{bmatrix} \\
  \frac{\partial \vec{T}}{\partial \vec{x}} \vec{g}(\vec{x})
  &= 
  \begin{bmatrix}
    \vec{0}        \\
    g_b(\vec{\eta},\xi)
  \end{bmatrix}
  \ \ \ .
  \label{eq:transformXDerivative}
\end{align}
\autoref{eq:transformXDerivative} results in the following four equations,
\begin{align}
    \frac{\partial \eta_1}{\partial x_3} g_1 + \frac{\partial \eta_1}{\partial x_4} g_2 &= 0                    \label{eq:chooseEta1}  \\
    \frac{\partial \eta_2}{\partial x_3} g_1 + \frac{\partial \eta_2}{\partial x_4} g_2 &= 0                    \label{eq:chooseEta2}  \\
    \frac{\partial \eta_3}{\partial x_3} g_1 + \frac{\partial \eta_3}{\partial x_4} g_2 &= 0                    \label{eq:chooseEta3}  \\
    \frac{\partial \xi   }{\partial x_3} g_1 + \frac{\partial \xi   }{\partial x_4} g_2 &= g_b(\vec{\eta},\xi)  \label{eq:chooseXi} 
\ \ \ ,
\end{align}
where,
\begin{align}
g_1 = \frac{\cos x_1}{l (M + m - m \cos^2 x1)}\\
g_2 = \frac{1}{M + m - m \cos^2 x_1 }
\end{align}

Det er her jeg går fast, jeg har ingen framework til at vælge kooredinaterne.\\
De kriterier jeg lige kan finde er at \autoref{eq:chooseEta1}-\ref{eq:chooseXi} skal være opfyldt og at $\vec{T}$ ikke må miste rang.

Jeg har skrevet ned her hvordan jeg har brugt en metode fra Khalil, som man bruger i forbindelse med input-output linearisering, men som jeg fik at vide jeg ikke skulle bruges til det her. Jeg får to mulige resultater, og begge opfylder de kriterier jeg kan se der måtte være. Det eneste der rigtig er til forskel så vidt jeg kan se, er hvorhenne man ender med noget andet end en state, $x_{1-4}$, direkte i transformen. Det kan være jeg bare kigger de forkerte steder i bogen? Selv hvis der er en anden metode vil jeg også gerne prøve at forstå hvorfor det her ikke er en måde at vælge transformen på.

Hvis jeg vælger input $h(x) = \theta$ eller $h(x) = x$, så får jeg relative degree $\rho = 2$ fordi\\
$\ddot{\theta} = \dot{x}_3 = f_1 + g_1 u$ \\
og\\
$\ddot{x} = \dot{x}_4 = f_2 + g_2 u$ \\
så kan jeg sige at 
\begin{align}
  \begin{bmatrix}
    \eta_1   \\
    \eta_2   \\
    \eta_3   \\
    \xi
  \end{bmatrix}
  =
  \begin{bmatrix}
    \eta_1   \\
    \eta_2   \\
    h(x)   \\
    L_f h(x)
  \end{bmatrix} \ \ \mathrm{så\ enten,} \ \ \ 
  \begin{bmatrix}
  \eta_1   \\
  \eta_2   \\
  \eta_3   \\
  \xi
  \end{bmatrix}
  =
  \begin{bmatrix}
  \eta_1   \\
  \eta_2   \\
  x_1   \\
  x_3
  \end{bmatrix} \ \ \ \mathrm{eller,} \ \ \
  \begin{bmatrix}
  \eta_1   \\
  \eta_2   \\
  \eta_3   \\
  \xi
  \end{bmatrix}
  =
  \begin{bmatrix}
  \eta_1   \\
  \eta_2   \\
  x_2   \\
  x_4
  \end{bmatrix}
\end{align}
det reducerer \autoref{eq:chooseEta1}-\ref{eq:chooseXi} til
\begin{align}
\frac{\partial \eta_1}{\partial x_3} g_1 + \frac{\partial \eta_1}{\partial x_4} g_2 &= 0                    \label{eq:chooseEta12}  \\
\frac{\partial \eta_2}{\partial x_3} g_1 + \frac{\partial \eta_2}{\partial x_4} g_2 &= 0                    \label{eq:chooseEta22}  \\
0 &= 0                    \label{eq:chooseEta32}  \\
g_1 &= g_b(\vec{\eta},\xi)  \ \ \mathrm{eller} \ \ \ g_2 = g_b(\vec{\eta},\xi)  \label{eq:chooseXi2} 
\ \ \ .
\end{align}
hvis $h(x) = x_1$ så kan jeg vælge $\eta_1 = x_2$ for opfylde \ref{eq:chooseEta12} uden at miste rang i $\vec{T}$, og \\
hvis $h(x) = x_2$ så kan jeg vælge $\eta_1 = x_1$

For til sidst at opfylde
\begin{align}
 \frac{\partial \eta_2}{\partial x_3} g_1 + \frac{\partial \eta_2}{\partial x_4} g_2 = 0
\end{align}
hvor,
\begin{align}
  g_1 = \frac{\cos x_1}{l (M + m - m \cos^2 x1)}\\
  g_2 = \frac{1}{M + m - m \cos^2 x_1 }
\end{align}
kan det vælges at
\begin{align}
\frac{\partial \eta_2}{\partial x_4} = \frac{\cos x_1}{l}  \ \ , \ \ \ \frac{\partial \eta_2}{\partial x_3}  = -1
\end{align}
så
\begin{align}
\eta_2 =  \frac{\cos x_1}{l} x_4 - x_3
\end{align}

\begin{align}
\mathrm{så\ enten,} \ \ \ 
\begin{bmatrix}
\eta_1   \\
\eta_2   \\
\eta_3   \\
\xi
\end{bmatrix}
=
\begin{bmatrix}
x_2   \\
\frac{\cos x_1}{l} x_4 - x_3  \\
x_1   \\
x_3
\end{bmatrix} \ \ \ \mathrm{eller,} \ \ \
\begin{bmatrix}
\eta_1   \\
\eta_2   \\
\eta_3   \\
\xi
\end{bmatrix}
=
\begin{bmatrix}
x_1   \\
\frac{\cos x_1}{l} x_4 - x_3   \\
x_2   \\
x_4
\end{bmatrix}
\end{align}



final transform
\begin{align}
  T
  = 
  \begin{bmatrix}
  \eta_1   \\
  \eta_2   \\
  \eta_3   \\
  \xi
  \end{bmatrix}
  =
  \begin{bmatrix}
  x_2   \\
  \frac{\cos x_1}{l} x_4 - x_3  \\
  x_1   \\
  x_3
  \end{bmatrix} \ \ \ .
  \label{eq:transform}
\end{align}

inverse transform
\begin{align}
  T^{-1} = 
  \begin{bmatrix}
    x_1  \\
    x_2  \\
    x_3  \\
    x_4
  \end{bmatrix}
  =
  %\begin{bmatrix}
  %\eta_1   \\
  %\eta_2   \\
  %\eta_3   \\
  %\xi
  %\end{bmatrix} \ \ \ .
  \label{eq:inverseTransform}
\end{align}

transform derivative,
\begin{align}
\\
:transform_dt}
\end{align}

from this the regular form \autoref{eq:regularForm} is achieved using the inverse transform to obtain full change of variables,
\begin{align}
  \begin{bmatrix}
    \dot{\eta}_1   \\
    \dot{\eta}_2   \\
    \dot{\eta}_3   \\  %these are dotted lines, yea, that's LaTeX for ya, go figure..
    \begin{picture} (0,0)(0,0) \multiput(-2,14)(4,0){3}{\line(2,0){2}} \end{picture}
    \dot{\xi}
  \end{bmatrix} 
  &=
  \overbrace{
    \underbrace{
      \begin{bmatrix}
        x_4    \\
        %\frac{l \sin x1}{\cos^2 x_1} x_3^2 +  \tfrac{l}{\cos x_1} f_1(\vec{x})  - f_2(\vec{x}) \\ 
        \sin x_1 x_4 x_3 + l f_1(\vec{x}) - \cos x_1 f_2(\vec{x})  \\
        x_3    \\ %these are dotted lines, yea, that's LaTeX for ya, go figure..
        \begin{picture} (0,0)(0,0) \multiput(-65,14)(4,0){40}{\line(2,0){2}} \end{picture}
        f_1(\vec{x}) 
      \end{bmatrix}
    }_{f_b} }^{f_a}
  +
  \underbrace{
    \begin{bmatrix}
      0    \\
      0    \\
      0    \\  %these are dotted lines, yea, that's LaTeX for ya, go figure..
      \begin{picture} (0,0)(0,0) \multiput(4,14)(4,0){17}{\line(2,0){2}} \end{picture}
      \frac{\cos x_1}{l (M + m - m \cos^2 x_1)}
    \end{bmatrix}
  }_{g_b} F  \ \ \ , &
  \label{eq:regularFormMatrix}
\end{align}


\begin{flalign}
s &=   \xi - \phi(\vec{\eta}) = 0     \ \ \ , &
\end{flalign}
design $\phi(\vec{\eta})$

if $s = 0$ then $\xi = \phi(\vec{\eta})$, that is, the reduced-order system,
\begin{flalign}
  \vec{\dot{\eta}} &=  f_a(\vec{\eta},\phi(\vec{\eta}))     \ \ \ , &
  \label{eq:asymStabOrigReducedOrder}
\end{flalign}
is asymptotically stable in the origin.

linearization of reduced-order system,
%
\begin{flalign}
A &= \frac{\partial \vec{\dot{\eta}}}{\partial \vec{\eta}} \whereThree{\vec{\eta}=\vec{0}\ \ \ \ }{\xi=0\ \ \ \ }{\text{k}_\text{tanh}=1} \ 
=
\begin{bmatrix}
0 & -1                  & 0 \\
0 & \frac{g_{p,c}}{l m} & g \\
0 & 0                   & 0 
\end{bmatrix}   \ \ \ , \ \ \
B = \frac{\partial \vec{\dot{\eta}}}{\partial \xi} \whereThree{\vec{\eta}=\vec{0}\ \ \ \ }{\xi=0\ \ \ \ }{\text{k}_\text{tanh}=1} \ 
=
\begin{bmatrix}
l  \\
\frac{-b_{p,v}-b_{p,c}}{l m}  \\
1  
\end{bmatrix}   \ \ \ , & 
\label{eq:linearReducedOrder_A}
\end{flalign}

stabilize reduced order system by,
\begin{flalign}
\phi(\vec{\eta}) &=   - \vec{k} \vec{\eta}  \ \ \ , &
\end{flalign}

design $u$ to bring $s$ to zero.\\
Lyapunov function candidate, $V = \frac{1}{2}s^2$,
derivative along trajectories of system
\begin{flalign}
\dot{V} &= s\dot{s} & \\
\dot{V} &= s ( \dot{\xi} + \vec{k}\vec{\dot{\eta}}  ) & \\
\dot{V} &= s ( f_b(\vec{\eta},\xi) + g_b(\vec{\eta},\xi) F +\vec{k}f_a(\vec{\eta},\xi) )  & \\
\dot{V} &= ( \vec{k}f_a(\vec{\eta},\xi)  +  f_b(\vec{\eta},\xi) )s + g_b(\vec{\eta},\xi) s F  & \\
\dot{V} &= g_b(\vec{\eta},\xi) s (\vec{k}f_a(\vec{\eta},\xi)  +  f_b(\vec{\eta},\xi)) g_b^{-1}(\vec{\eta},\xi) + g_b(\vec{\eta},\xi) s F  &  \\
\dot{V} &\leq g_b(\vec{\eta},\xi) |s| \left|\vec{k}f_a(\vec{\eta},\xi) g_b^{-1}(\vec{\eta},\xi) +  f_b(\vec{\eta},\xi) \right| + g_b(\vec{\eta},\xi) s F  \ \ \ . &
\label{eq:lyapunov}
\end{flalign}

$|s| = \text{sgn}(s) s$
 
\begin{flalign}
\dot{V} &\leq g_b(\vec{\eta},\xi) |s| \left|\vec{k}f_a(\vec{\eta},\xi) +  f_b(\vec{\eta},\xi) \right|  g_b^{-1}(\vec{\eta},\xi)  & \nonumber \\
&- g_b(\vec{\eta},\xi) \text{sgn}(s) s \left|\vec{k}f_a(\vec{\eta},\xi)  +  f_b(\vec{\eta},\xi) \right| g_b^{-1}(\vec{\eta},\xi)  &
\label{eq:lyapunov2}
\end{flalign}
s.t.
\begin{flalign}
u &= -\text{sgn}(s)\varrho(\vec{\eta},\xi) g_b^{-1}(\vec{\eta},\xi) \ \ \ \ \text{where}, \ \ \ \varrho(\vec{\eta},\xi)  \geq \left|\vec{k}f_a(\vec{\eta},\xi)  +  f_b(\vec{\eta},\xi) \right|   \ \ \ , &
\label{eq:ssControlBeta}
\end{flalign}

tuning parameter, $\beta_0$

\begin{flalign}
  u &= -\text{sgn}(s)\beta (\vec{\eta},\xi) g_b^{-1}(\vec{\eta},\xi) \ \ \ \ \text{where}, \ \ \ \beta(\vec{\eta},\xi) = \varrho(\vec{\eta},\xi) + \beta_0  \ \ \ . &
\label{eq:ssControlBeta0}
\end{flalign}

sign-function discontinuity\\
sat-function used
\begin{flalign}
\text{sat}\left( \tfrac{s}{\varepsilon} \right) &=
\begin{cases}
\ \ \frac{s}{\varepsilon},                           & \ \text{if} \ | \frac{s}{\varepsilon} | \leq 1 \\
\ \ \text{sgn}\left( \tfrac{s}{\varepsilon} \right), & \ \text{if} \ | \frac{s}{\varepsilon} |  >   1 \ \ \ ,
\end{cases} & 
\label{eq:satuationFunction2}
\end{flalign}
where $\frac{1}{\varepsilon}$ slope
\begin{flalign}
u &= -\text{sat}(\tfrac{s}{\varepsilon})\beta (\vec{\eta},\xi)  g_b^{-1}(\vec{\eta},\xi) \ \ \ \ \text{where}, \ \ \ \beta(\vec{\eta},\xi) = \varrho(\vec{\eta},\xi) + \beta_0  \ \ \ . &
\label{eq:ssControlSat}
\end{flalign}
%

